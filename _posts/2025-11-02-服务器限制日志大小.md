---
title: "服务器限制日志大小"
layout: post
tags:
  - linux
  - nginx
category: it
---

# Nginx限制日志大小

本文记录常见的日志管理方法，包含：清空 Nginx 日志、配置 logrotate、配置 Nginx 日志格式，以及限制 systemd-journald 占用的磁盘空间并手动清理旧日志。

## 清空日志（不中断 Nginx）

直接清空访问日志同时不重启 Nginx：

```bash
truncate -s 0 /var/log/nginx/access.log
```

## 配置 logrotate

编辑 logrotate 配置文件：

```bash
nano /etc/logrotate.d/nginx
```

示例配置（放在 `/etc/logrotate.d/nginx`）：

```ini
/var/log/nginx/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    maxsize 100M
    create 0640 www-data adm
    sharedscripts
    postrotate
        # 使用实际 PID 文件位置
        [ -f /run/nginx.pid ] && kill -USR1 `cat /run/nginx.pid`
    endscript
}
```

测试 `logrotate` 配置是否正确（调试模式）：

```bash
logrotate -d /etc/logrotate.d/nginx
```

强制执行一次轮转以确认生效：

```bash
sudo logrotate -f /etc/logrotate.d/nginx
```

查看日志目录，确认已轮转并压缩：

```bash
ls -lh /var/log/nginx/
```

## 配置 Nginx 日志格式

编辑 Nginx 主配置（例如 `/etc/nginx/nginx.conf`），设置错误日志和访问日志格式：

```nginx
error_log /var/log/nginx/error.log warn;

log_format minimal '$remote_addr $request $status';
access_log /var/log/nginx/access.log minimal;
```

修改后请测试并重载 Nginx：

```bash
sudo nginx -t && sudo systemctl reload nginx
```

# 限制 systemd-journald 占用空间

编辑 `journald` 配置文件：

```bash
nano /etc/systemd/journald.conf
```

在文件中设置最大使用空间，例如：

```ini
[Journal]
SystemMaxUse=512M
SystemKeepFree=1G
# ...
```

保存后重启 `systemd-journald` 服务使配置生效：

```bash
sudo systemctl restart systemd-journald.service
```

检查当前磁盘使用情况：

```bash
journalctl --disk-usage
```

你也可以查看 `journald` 服务日志来确认是否遵守了新的限制：

```bash
journalctl -u systemd-journald --since today | grep "System Journal"
```

## 手动清除旧日志（立即生效）

按大小清理（保留最近占用不超过指定大小的日志）：

```bash
sudo journalctl --vacuum-size=500M
```

按时间清理（清除早于指定时间的日志）：

```bash
sudo journalctl --vacuum-time=7days
```
